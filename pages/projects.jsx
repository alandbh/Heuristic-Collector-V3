import { gql, useQuery } from "@apollo/client";
import ClientOnly from "../lib/ClientOnly";
import Card from "../components/Card";
import { useAuthState } from "react-firebase-hooks/auth";
import { auth } from "../lib/firebase";
import { useRouter } from "next/router";

import Logo from "../components/Logo";
import LoggedUser from "../components/LoggedUser";
import Link from "next/link";
import Head from "next/head";
import { isUserAuthorized, sortCollection } from "../lib/utils";

const QUERY_PROJECTS = gql`
    query {
        projects(orderBy: name_DESC) {
            id
            name
            slug
            year
            public
            journeys(first: 1000, orderBy: slug_ASC) {
                slug
            }
            players(first: 1000, orderBy: slug_ASC) {
                slug
            }
            thumbnail {
                url
            }
        }
    }
`;

const QUERY_USER = gql`
    query getRgaUser($email: String) {
        rgaUsers(where: { email: $email }) {
            id
            email
            userType
            project {
                slug
            }
        }
    }
`;

function Projects(props) {
    const { data, loading, error } = useQuery(QUERY_PROJECTS);
    const [user, loadingUser] = useAuthState(auth);
    const router = useRouter();
    const { data: rgaUsersRetrieved } = useQuery(QUERY_USER, {
        variables: { email: user?.email },
    });

    // console.log("withPageAuthRequired", props.user);
    // const { user, error: errorUser, isLoading } = useUser();

    function isPresentInThisProject(projectSlug) {
        const projectsWhereThisUserIsPresent = rgaUsersRetrieved?.rgaUsers.map(
            (user) => user.project.slug
        );
        return projectsWhereThisUserIsPresent?.includes(projectSlug);
    }

    // console.log("user-", rgaUsersRetrieved);

    if (typeof window !== "undefined") {
        if (!user && !loadingUser) {
            router.push("/login");
            // return;
        }
    }

    if (!user) {
        // router.push("/login");
        return null;
    }

    // console.log(data.projects);

    const projectsToMapUnsorted = data?.projects.filter((project) => {
        if (!isUserAuthorized(user)) {
            return project.public === true;
        }

        return isPresentInThisProject(project.slug);

        // return true;
    });

    const projectsToMap =
        projectsToMapUnsorted &&
        sortCollection(projectsToMapUnsorted, "id").reverse();

    // console.log("projectsMap", projectsToMap);
    if (projectsToMap === undefined) {
        return null;
    }
    // projectsToMap

    return (
        <>
            <Head>
                <meta charSet="utf-8" />
                <meta httpEquiv="X-UA-Compatible" content="IE=edge" />
                <meta
                    name="viewport"
                    content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"
                />
                <meta name="description" content="R/GA's Heuristic Collector" />
                <meta name="theme-color" content="#dd0000" />
                <title>R/GA&apos;s Heuristic Collector</title>
                <link rel="manifest" href="/manifest.json" />
                <link rel="shortcut icon" href="/favicon.ico" />
                <link
                    rel="apple-touch-icon"
                    href="/apple-touch-icon.png"
                ></link>
                <link
                    rel="android-chrome-192x192"
                    href="/android-chrome-192x192.png"
                ></link>
            </Head>
            <ClientOnly className="flex flex-col h-screen">
                <div className="flex px-4 w-full justify-between my-10">
                    <Link href={`/`}>
                        <a>
                            <Logo />
                        </a>
                    </Link>

                    <div className="flex items-center gap-5">
                        <LoggedUser
                            picture={user?.photoURL}
                            name={user?.displayName.split(" ")[0]}
                            email={user?.email}
                            size={40}
                            auth={auth}
                        />
                    </div>
                </div>

                {projectsToMap?.length === 0 && (
                    <div className="flex flex-col items-center">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="136.718"
                            height="137.454"
                            viewBox="0 0 136.718 137.454"
                        >
                            <path
                                fill="none"
                                d="M0 0H136.718V137.454H0z"
                            ></path>
                            <path
                                fill="none"
                                stroke="#000"
                                strokeLinecap="round"
                                strokeWidth="4"
                                d="M58.69.72c8.63-.8 18.32 1.52 26.34 5.65 8.02 4.14 16.52 11.45 21.77 19.13 5.26 7.69 8.65 17.84 9.76 26.97 1.11 9.12.35 19.23-3.09 27.79-3.45 8.55-10.56 17.7-17.57 23.51-7 5.82-15.83 9.53-24.48 11.38-8.64 1.85-18.66 1.86-27.4-.3-8.74-2.16-18.28-6.73-25.04-12.66-6.75-5.92-12.24-14.57-15.47-22.92-3.23-8.35-5.22-18.18-3.93-27.2 1.28-9.01 6.16-19.24 11.65-26.89 5.49-7.65 12.11-14.93 21.29-19.01C41.69 2.09 59.47 1.24 66.3.71c6.83-.52 7.26 1.22 7.21 2.31M62 .26c8.66.18 19.86 4.75 27.7 9.47 7.84 4.72 15 10.89 19.35 18.84 4.35 7.94 6.29 19.62 6.72 28.82.43 9.19-.29 18.46-4.15 26.35-3.85 7.88-11.49 15.49-19 20.95-7.52 5.47-17.28 10.44-26.08 11.81-8.8 1.37-18.3-.5-26.73-3.6-8.42-3.1-17.7-8.49-23.82-15.01-6.12-6.52-10.26-15.56-12.91-24.1C.44 65.25-1.73 55.25.15 46.63c1.87-8.62 8.1-17.47 14.2-24.56S28.53 7.79 36.76 4.1C44.99.41 59.47.21 63.75-.07c4.29-.29-.93 1.53-1.28 2.49"
                                transform="translate(10 10)"
                            ></path>
                            <path
                                d="M-1.99-1.77l.62-.74q.61-.73 1.61-2.21T2-7.35Q2.76-8.5 4.33-9.7q1.56-1.21 2.84-1.8 1.28-.59 2.73-.95 1.44-.37 2.75-.44 1.32-.08 2.41-.25 1.09-.17 2.4-.19 1.31-.03 2.48-.04 1.16-.01 2.37-.05 1.21-.03 2.45.11 1.25.14 2.39.31 1.14.17 2.16.6 1.03.42 2.47 1.07 1.44.66 2.72 1.31 1.27.66 2.17 1.3l2.25 1.58q1.34.95 2.3 1.56.95.62 2.94 2.05 1.99 1.43 2.28 1.94.29.5.4 1.08.11.56.04 1.14-.08.58-.34 1.1-.26.53-.67.94-.41.42-.94.68-.52.26-1.1.34-.58.08-1.15-.03-.58-.11-1.08-.39-.51-.29-.91-.72-.39-.44-.62-.97-.23-.54-.28-1.12-.05-.58.09-1.14.14-.57.45-1.06.32-.5.77-.86.46-.37 1-.58.55-.2 1.14-.22.58-.01 1.14.16.56.17 1.04.51.47.34.81.81.35.48.52 1.03.17.56.16 1.14-.02.58-.22 1.13-.2.55-.56 1.01-.37.45-.86.77-.49.31-1.06.46-.57.14-1.15.09-.58-.04-1.12-.27-.54-.23-.97-.62l-.44-.39-.78-.46q-.77-.45-2.09-1.29Q36.35-.15 35-1.1l-2.4-1.67q-1.04-.72-2.22-1.3-1.17-.57-2.54-1.27-1.36-.69-2.84-.9-1.48-.2-2.69-.24-1.21-.03-2.37-.05-1.16-.01-2.72 0-1.57 0-2.81.1-1.24.09-2.42.2-1.17.12-2.28.46-1.1.34-2.09 1.07-.98.73-1.77 1.69-.79.97-1.66 2.18-.88 1.2-1.54 1.9t-.9.91q-.24.21-.53.36-.28.15-.6.23-.31.07-.62.07-.32 0-.63-.07-.32-.08-.6-.23-.28-.15-.53-.36-.24-.22-.42-.48-.18-.27-.29-.57-.12-.3-.16-.62-.03-.31.01-.63.03-.32.15-.62.11-.3.3-.56l.18-.27z"
                                transform="translate(50.685 93.529)"
                            ></path>
                            <path
                                d="M-.57-2.59l.7-.2q.7-.2 1.91-.87 1.21-.66 2.19-1.32t2.38-2.39q1.4-1.72 2.52-2.4 1.12-.69 2.32-1.61 1.19-.93 1.52-.02.33.9.18.38-.14-.51-.12-1.05.03-.54.23-1.04.19-.5.54-.92.35-.41.81-.69.46-.28.98-.4.53-.11 1.07-.06.53.06 1.02.28.49.23.88.59.4.37.65.85.26.47.35 1 .09.54 0 1.07-.08.53-.33 1.01-.25.47-.64.85-.39.37-.88.6-.49.23-1.03.29-.53.06-1.06-.06-.52-.11-.99-.39-.46-.27-.81-.68-.35-.41-.55-.91-.2-.5-.24-1.04-.03-.53.11-1.05.15-.52.45-.97.3-.45.72-.78.43-.32.94-.5.51-.17 1.05-.18.54 0 1.05.17t.94.5q.43.32.74.76l.3.45-1.43 3.22q-1.43 3.23-2.45 3.97-1.02.73-2.58 1.4-1.56.68-2.33 1.68-.76 1.01-2.36 2.27Q6.57.48 5.4 1.14q-1.16.66-2.27.94-1.1.27-1.83.39t-1.05.16q-.31.03-.62-.02-.32-.05-.62-.17-.3-.12-.56-.31-.26-.18-.46-.43-.21-.24-.35-.53-.15-.29-.21-.6-.07-.32-.07-.63.01-.32.09-.63.09-.31.24-.59.16-.28.38-.51.22-.24.48-.41.27-.18.58-.29l.3-.1z"
                                transform="translate(29.794 56.181)"
                            ></path>
                            <path
                                d="M-.68 2.53l-1.45-.42q-1.45-.42-2.59-.84l-2.36-.9Q-8.31-.09-9.73-.8t-2.78-1.71q-1.36-1-2.3-1.81-.93-.82-1.72-2.1-.78-1.29-1.64-2.73-.87-1.44-1-1.97-.12-.52-.08-1.05.05-.54.26-1.03.21-.49.58-.89.36-.4.82-.66.47-.26 1-.36.53-.1 1.06-.02.53.07 1.01.31t.86.62q.38.38.61.87.24.48.31 1.01t-.03 1.06q-.11.53-.37.99-.27.47-.67.82-.4.36-.9.57-.49.21-1.03.25-.53.04-1.05-.09t-.97-.42q-.45-.29-.79-.71-.33-.42-.52-.93-.18-.5-.19-1.04-.01-.53.15-1.05.16-.51.47-.94.32-.44.75-.75.44-.31.96-.47.51-.15 1.05-.13.53.01 1.04.2.5.19.92.52.41.34.7.8l.29.45.94 1.83q.94 1.83 1.8 2.74.87.91 1.91 1.77 1.04.85 2.21 1.56 1.18.71 2.51 1.37 1.33.65 2.79 1.02 1.45.37 1.74.49.3.12.55.31.26.18.46.42.21.24.35.53.14.28.21.59.07.31.06.61-.01.32-.09.63-.08.3-.24.58-.15.28-.36.51-.22.23-.48.4-.27.18-.57.28-.3.11-.61.14-.31.03-.62-.02l-.31-.04z"
                                transform="translate(108.603 56.319)"
                            ></path>
                            <path
                                d="M1.2-2.16l.73.36q.74.35 1.41.29.66-.06.99.01.33.06.64.21.3.14.56.36.27.21.47.48.2.27.34.57.13.31.18.64.06.34.03.68-.03.33-.13.65-.11.32-.29.61-.18.28-.42.52-.25.23-.54.4-.29.17-.62.27-.32.09-.66.11-.34.01-1.35-.81Q1.53 2.37.86 1.52.19.66 1.5.96q1.3.3 1.03.72-.28.41-.67.72-.4.3-.87.47-.47.16-.97.17-.49 0-.96-.16-.48-.15-.87-.45-.4-.3-.69-.71-.28-.41-.42-.89-.14-.48-.11-.96.02-.5.2-.97.18-.46.5-.84.32-.39.75-.65.42-.26.91-.37.48-.11.97-.06t.95.25q.45.21.82.55.36.34.6.78t.32.93q.09.49.01.97-.08.49-.31.94-.23.44-.59.78-.35.35-.81.56-.45.22-.94.27-.49.06-.97-.04-.49-.1-.92-.36-.43-.25-.76-.63-.32-.37-.51-.84Q-3 .68-3.03.18q-.03-.48.1-.96l.13-.49q0 .01 2.81-1.37 2.82-1.38 3.93-.68 1.11.7 1.6 1.84.5 1.14-.52.53Q4-1.57 4.33-1.5q.33.06.64.21.3.14.56.36.27.21.47.48.2.27.34.57.13.31.18.64.06.34.03.67-.03.34-.13.66-.11.32-.29.61-.18.28-.42.52-.25.23-.54.4-.29.17-.62.27-.32.09-.66.11-.34.01-1-.05-.66-.05-1.68-.48T-.5 2.6q-.7-.44-.94-.62-.24-.17-.43-.4t-.32-.5q-.14-.26-.2-.55-.06-.3-.06-.58.01-.3.09-.59t.22-.55q.15-.26.35-.48.2-.21.45-.38.25-.16.53-.26t.58-.13q.28-.03.58.02.29.04.57.15l.28.11z"
                                transform="translate(47.601 58.266)"
                            ></path>
                            <path
                                d="M1.9 1.52l-.25.38q-.26.37-.2-.78.05-1.14-.94.6-.99 1.75-2.12 1.39-1.14-.37.28-.68 1.41-.31.25.24-1.17.54-1.37.64-.21.1-.6.18-.39.07-.79.06-.4-.02-.79-.13-.38-.12-.73-.32-.34-.2-.63-.48-.29-.28-.5-.62-.21-.34-.34-.72Q-6.95.9-6.99.5q-.03-.4.04-.78.07-.4.22-.77.16-.36.41-.68.24-.32.55-.57.31-.26.67-.43.37-.17 1.84 2.6 1.48 2.75 2.07 1.19Q-.6-.49-.53-.1q.07.39.05.79-.02.4-.14.78-.12.38-.33.73-.2.34-.49.63-.28.28-.62.49-.34.21-.73.33-.38.12-.78.14-.4.03-.8-.04-.39-.07-.76-.24-.36-.16-.68-.41-.32-.24-.56-.56-.25-.32-.42-.68-.16-.37 2.51-1.86 2.67-1.49 2.49-2.08-.17-.59.31-.84.48-.24 1.01-.32.52-.08 1.05.02.53.09 1 .35t.83.66q.37.4.58.89.22.49.27 1.03.05.52-.08 1.04-.12.53-.4.98-.29.46-.71.8-.41.34-.91.53-.51.19-1.04.21-.53.02-1.05-.13-.51-.15-.95-.46-.44-.31-.76-.75-.32-.43-.48-.94-.16-.51-.15-1.04.01-.54.19-1.04.18-.51.51-.93.33-.43.78-.72t.97-.43q.52-.13 1.05-.1.53.04 1.03.25t.9.56q.4.36.67.82.27.47.38 1 .11.52.04 1.05t-.3 1.01q-.24.49-.61.87l-.38.38-2.88.71q-2.89.7-3.85-.06-.97-.76 1.6-2.29Q-.6-.49-.53-.1q.07.39.05.79-.02.4-.14.78-.12.38-.33.73-.2.34-.49.63-.28.28-.62.49-.34.21-.73.33-.38.12-.78.14-.4.03-.8-.04-.39-.07-.76-.24-.36-.16-.68-.41-.32-.24-.56-.56-.25-.31-.42-.68-.16-.37.56-1.99.72-1.64 2.15.95 1.42 2.59 1.03 2.67-.39.07-.79.06-.4-.02-.79-.13-.38-.12-.73-.32-.34-.2-.63-.48-.29-.28-.5-.62-.21-.34-.34-.72Q-6.95.9-6.99.5q-.03-.4.04-.78.07-.4.22-.77.16-.36.41-.68.24-.32.55-.57.31-.26.67-.43.37-.17-.07.29-.43.45.89 0t2.83-.41q1.5.04 2.4.79.89.74 1.79 1.77Q3.63.74 2.45 3 1.27 5.27 0 4.8q-1.26-.48-2.1-1.27-.85-.79-.71-2.5t.53-2.13q.38-.42.59-.63.21-.2.46-.35.25-.15.54-.24.28-.08.57-.1.29-.01.58.04.29.06.55.18.27.13.5.31.23.19.41.42.18.23.3.5.11.27.16.56.06.29.03.58-.02.29-.11.57-.09.28-.24.53l-.16.25z"
                                transform="translate(91.33 57.715)"
                            ></path>
                        </svg>
                        <h1>
                            Sorry. This space is only for RGA{"'"}s fellows.
                        </h1>
                    </div>
                )}
                <div className=" px-4 mx-auto md:mt-10 flex flex-wrap gap-6 md:gap-10 sm:justify-center md:justify-items-start">
                    {projectsToMap?.map((proj) => (
                        <Card key={proj.id} data={proj} />
                    ))}
                </div>
                <div className="flex flex-col flex-1 mt-auto align-baseline">
                    <pre className="text-xs text-slate-500 mt-auto">
                        Environment: {process.env.NODE_ENV}
                    </pre>
                </div>
            </ClientOnly>
        </>
    );
}

export default Projects;
